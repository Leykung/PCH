<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Mini‚ÄëDashboard (LIFF)</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* Safe area for notched phones */
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    body { padding-bottom: calc(12px + var(--safe-bottom)); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <img id="userPicture" class="w-9 h-9 rounded-full hidden" alt="profile" />
      <div>
        <h1 class="text-lg font-semibold">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‡∏£‡∏û. (Mini)</h1>
        <p id="userName" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‚Ä¶</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnShare" class="px-3 py-1.5 rounded-xl bg-black text-white text-sm">‡πÅ‡∏ä‡∏£‡πå</button>
        <button id="btnScan" class="px-3 py-1.5 rounded-xl bg-gray-800 text-white text-sm">‡∏™‡πÅ‡∏Å‡∏ô</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4">
    <!-- Alerts -->
    <div id="alert" class="hidden mb-4 rounded-xl p-3 text-sm bg-yellow-50 border border-yellow-200 text-yellow-800"></div>

    <!-- KPI Cards -->
    <section aria-labelledby="kpiTitle" class="mb-5">
      <h2 id="kpiTitle" class="text-base font-semibold mb-3">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
          <p id="kpiPatients" class="text-2xl font-bold mt-1">‚Äî</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ö‡∏≤‡∏ó)</p>
          <p id="kpiRevenue" class="text-2xl font-bold mt-1">‚Äî</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠</p>
          <p id="kpiQueue" class="text-2xl font-bold mt-1">‚Äî</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏ß‡πà‡∏≤‡∏á</p>
          <p id="kpiBeds" class="text-2xl font-bold mt-1">‚Äî</p>
        </div>
      </div>
    </section>

    <!-- Chart -->
    <section class="mb-6">
      <div class="rounded-2xl p-4 bg-white shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Top 5 ‡πÇ‡∏£‡∏Ñ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <button id="btnRefresh" class="text-sm px-3 py-1.5 rounded-xl border">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
        <canvas id="diseaseChart" height="140"></canvas>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="mb-20">
      <h2 class="text-base font-semibold mb-3">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="sendToBot('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')">
          <p class="text-sm font-medium">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          <p class="text-xs text-gray-500">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏≠‡∏ó</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="sendToBot('‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')">
          <p class="text-sm font-medium">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          <p class="text-xs text-gray-500">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏≠‡∏ó</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="openPortal()">
          <p class="text-sm font-medium">‡πÄ‡∏õ‡∏¥‡∏î HIS Portal</p>
          <p class="text-xs text-gray-500">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="openMap()">
          <p class="text-sm font-medium">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏ï‡∏∂‡∏Å</p>
          <p class="text-xs text-gray-500">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
        </button>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 py-6">¬© ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</footer>
  </main>

  <script>
    // ====== CONFIG ======
    const LIFF_ID = "YOUR_LIFF_ID";                 // üëà ‡πÉ‡∏™‡πà LIFF ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å LINE Developers
    const API_BASE = "https://yourdomain.example/api"; // üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô API ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (n8n/PHP)
    const HOSPITAL_PORTAL_URL = "https://his.example/login"; // üëà Portal/HIS URL

    // ====== STATE ======
    let chart;

    // ====== HELPERS ======
    const THB = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(n || 0);
    const NUM = n => new Intl.NumberFormat('th-TH').format(n || 0);

    function showAlert(msg) {
      const el = document.getElementById('alert');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 5000);
    }

    async function fetchJSON(path) {
      const res = await fetch(path, { credentials: 'include' });
      if (!res.ok) throw new Error('API error: ' + res.status);
      return await res.json();
    }

    // ====== ACTIONS ======
    async function loadKPIs() {
      try {
        const data = await fetchJSON(`${API_BASE}/hospital/kpi/today`);
        document.getElementById('kpiPatients').textContent = NUM(data.patients);
        document.getElementById('kpiRevenue').textContent = THB(data.revenue);
        document.getElementById('kpiQueue').textContent = NUM(data.queue_waiting);
        document.getElementById('kpiBeds').textContent = NUM(data.beds_free);
      } catch (e) {
        showAlert('‡∏î‡∏∂‡∏á KPI ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.error(e);
      }
    }

    async function loadTopDiseases() {
      try {
        const data = await fetchJSON(`${API_BASE}/hospital/top-diseases?limit=5`);
        const labels = data.map(d => `${d.icd} ‚Äî ${d.name}`);
        const counts = data.map(d => d.count);
        const ctx = document.getElementById('diseaseChart');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', data: counts }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } catch (e) {
        showAlert('‡∏î‡∏∂‡∏á Top ‡πÇ‡∏£‡∏Ñ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.error(e);
      }
    }

    async function sendToBot(text) {
      try {
        if (!liff.isInClient()) {
          showAlert('‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
          return;
        }
        await liff.sendMessages([{ type: 'text', text }]);
        showAlert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ö‡∏≠‡∏ó‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        showAlert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        console.error(e);
      }
    }

    async function openPortal() {
      liff.openWindow({ url: HOSPITAL_PORTAL_URL, external: true });
    }

    async function openMap() {
      liff.openWindow({ url: `${API_BASE}/hospital/map`, external: false });
    }

    async function doShare() {
      try {
        if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([
            { type: 'text', text: '‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Äî ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà: ' + window.location.href }
          ]);
        } else {
          await liff.sendMessages([{ type: 'text', text: '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ' + window.location.href }]);
        }
        showAlert('‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } catch (e) {
        console.error(e);
        showAlert('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }

    async function scanCode() {
      try {
        if (!liff.isInClient() || !liff.isApiAvailable('scanCodeV2')) {
          showAlert('‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ');
          return;
        }
        const res = await liff.scanCodeV2();
        if (res && res.value) showAlert('‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ' + res.value);
      } catch (e) {
        console.error(e);
        showAlert('‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    }

    // ====== BOOT ======
    async function boot() {
      try {
        await liff.init({ liffId: LIFF_ID });

        // Login if needed (in external browser mode)
        if (!liff.isLoggedIn()) liff.login();

        // Load profile
        const profile = await liff.getProfile();
        document.getElementById('userName').textContent = `‡∏Ñ‡∏∏‡∏ì ${profile.displayName}`;
        const pic = document.getElementById('userPicture');
        pic.src = profile.pictureUrl; pic.classList.remove('hidden');

        // Load data
        await Promise.all([loadKPIs(), loadTopDiseases()]);

      } catch (e) {
        console.error(e);
        document.getElementById('userName').textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE ‡∏´‡∏£‡∏∑‡∏≠ LIFF ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°)';
        showAlert('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏≤‡∏ò‡∏¥‡∏ï ‚Äî ‡πÉ‡∏™‡πà LIFF_ID ‡πÅ‡∏•‡∏∞ API ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á');
        // Demo fallback data
        document.getElementById('kpiPatients').textContent = NUM(324);
        document.getElementById('kpiRevenue').textContent = THB(428000);
        document.getElementById('kpiQueue').textContent = NUM(27);
        document.getElementById('kpiBeds').textContent = NUM(14);
        const ctx = document.getElementById('diseaseChart');
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels: ['I10 ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', 'J00 ‚Äî ‡∏´‡∏ß‡∏±‡∏î', 'E119 ‚Äî ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', 'J029 ‚Äî ‡∏Ñ‡∏≠‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö', 'B24 ‚Äî HIV'], datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢', data: [135, 104, 66, 62, 81] }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      // Wire UI buttons
      document.getElementById('btnShare').addEventListener('click', doShare);
      document.getElementById('btnScan').addEventListener('click', scanCode);
      document.getElementById('btnRefresh').addEventListener('click', () => { loadKPIs(); loadTopDiseases(); });
    }

    boot();
  </script>
</body>
</html>
