<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Mini Dashboard</title>

  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- LIFF SDK (ถ้ายังไม่ใช้ เปิดคอมเมนต์บรรทัดล่างนี้เมื่อพร้อม) -->
  <!-- <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script> -->

  <meta name="description" content="Mini dashboard ตัวอย่างสำหรับโรงพยาบาล ใช้กับ GitHub Pages หรือ LIFF ได้" />
  <style>
    :root { --safe-bottom: env(safe-area-inset-bottom); }
    body { padding-bottom: calc(12px + var(--safe-bottom)); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <img id="userPicture" class="w-9 h-9 rounded-full hidden" alt="profile"/>
      <div>
        <h1 class="text-lg font-semibold">แดชบอร์ด รพ. (ตัวอย่าง)</h1>
        <p id="userName" class="text-xs text-gray-500">โหมดสาธิต (ยังไม่ได้เชื่อม LIFF)</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnShare" class="px-3 py-1.5 rounded-xl bg-black text-white text-sm">แชร์</button>
        <button id="btnScan" class="px-3 py-1.5 rounded-xl bg-gray-800 text-white text-sm">สแกน</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-4">
    <!-- Alert -->
    <div id="alert" class="hidden mb-4 rounded-xl p-3 text-sm bg-yellow-50 border border-yellow-200 text-yellow-800"></div>

    <!-- KPIs -->
    <section class="mb-5">
      <h2 class="text-base font-semibold mb-3">ภาพรวมวันนี้</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">ผู้รับบริการ (วันนี้)</p>
          <p id="kpiPatients" class="text-2xl font-bold mt-1">—</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">รายได้ (บาท)</p>
          <p id="kpiRevenue" class="text-2xl font-bold mt-1">—</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">คิวรอ</p>
          <p id="kpiQueue" class="text-2xl font-bold mt-1">—</p>
        </div>
        <div class="rounded-2xl p-4 bg-white shadow-sm border">
          <p class="text-xs text-gray-500">เตียงว่าง</p>
          <p id="kpiBeds" class="text-2xl font-bold mt-1">—</p>
        </div>
      </div>
    </section>

    <!-- Chart -->
    <section class="mb-6">
      <div class="rounded-2xl p-4 bg-white shadow-sm border">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Top 5 โรค เดือนนี้</h3>
          <button id="btnRefresh" class="text-sm px-3 py-1.5 rounded-xl border">รีเฟรช</button>
        </div>
        <canvas id="diseaseChart" height="140"></canvas>
      </div>
    </section>

    <!-- Quick actions -->
    <section class="mb-20">
      <h2 class="text-base font-semibold mb-3">คำสั่งด่วน</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="sendToBot('รายได้ วันนี้')">
          <p class="text-sm font-medium">รายได้ วันนี้</p>
          <p class="text-xs text-gray-500">ส่งคำสั่งไปยังบอท</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="sendToBot('ผู้รับบริการ วันนี้')">
          <p class="text-sm font-medium">ผู้รับบริการ วันนี้</p>
          <p class="text-xs text-gray-500">ส่งคำสั่งไปยังบอท</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="openPortal()">
          <p class="text-sm font-medium">เปิด HIS Portal</p>
          <p class="text-xs text-gray-500">ลิงก์ภายนอก</p>
        </button>
        <button class="rounded-2xl p-4 bg-white shadow-sm border text-left" onclick="openMap()">
          <p class="text-sm font-medium">แผนที่/ตึก</p>
          <p class="text-xs text-gray-500">เปิดหน้าข้อมูล</p>
        </button>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-400 py-6">© โรงพยาบาลของคุณ</footer>
  </main>

  <script>
    // ===== CONFIG (ปรับตามจริงเมื่อเชื่อม LIFF/API) =====
    const USE_LIFF = true;        // ตั้งเป็น true เมื่อเปิดใช้ LIFF SDK ด้านบน
    const LIFF_ID  = "2008079514-kma96pl0";
    const API_BASE = "https://example.com/api"; // เปลี่ยนเป็น API (n8n/PHP) ของคุณ
    const HOSPITAL_PORTAL_URL = "https://his.example/login";

    let chart;

    const THB = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(n || 0);
    const NUM = n => new Intl.NumberFormat('th-TH').format(n || 0);

    function showAlert(msg) {
      const el = document.getElementById('alert');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 4000);
    }

    async function fetchJSON(path) {
      const res = await fetch(path, { credentials: 'include' });
      if (!res.ok) throw new Error('API error: ' + res.status);
      return await res.json();
    }

    async function loadKPIs() {
      try {
        // ตัวอย่าง: ดึงจาก API จริง
        // const data = await fetchJSON(`${API_BASE}/hospital/kpi/today`);
        // DEMO:
        const data = { patients: 324, revenue: 428000, queue_waiting: 27, beds_free: 14 };
        document.getElementById('kpiPatients').textContent = NUM(data.patients);
        document.getElementById('kpiRevenue').textContent  = THB(data.revenue);
        document.getElementById('kpiQueue').textContent    = NUM(data.queue_waiting);
        document.getElementById('kpiBeds').textContent     = NUM(data.beds_free);
      } catch (e) { console.error(e); showAlert('ดึง KPI ไม่สำเร็จ'); }
    }

    async function loadTopDiseases() {
      try {
        // ตัวอย่าง: ดึงจาก API จริง
        // const data = await fetchJSON(`${API_BASE}/hospital/top-diseases?limit=5`);
        // DEMO:
        const data = [
          { icd:'I10',  name:'ความดันโลหิตสูง', count:135 },
          { icd:'J00',  name:'หวัด',            count:104 },
          { icd:'E119', name:'เบาหวาน',         count:66  },
          { icd:'J029', name:'คออักเสบ',        count:62  },
          { icd:'B24',  name:'HIV',             count:81  },
        ];
        const labels = data.map(d => `${d.icd} — ${d.name}`);
        const counts = data.map(d => d.count);
        const ctx = document.getElementById('diseaseChart');

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'จำนวนผู้ป่วย', data: counts }] },
          options: { plugins: { legend: { display:false } }, scales: { y: { beginAtZero:true } } }
        });
      } catch (e) { console.error(e); showAlert('ดึง Top โรคไม่สำเร็จ'); }
    }

    async function sendToBot(text) {
      try {
        if (!USE_LIFF || typeof liff === 'undefined') {
          showAlert('ส่งข้อความได้เมื่อเปิดใน LINE และเปิดใช้ LIFF');
          return;
        }
        if (!liff.isInClient()) { showAlert('ต้องเปิดใน LINE App'); return; }
        await liff.sendMessages([{ type:'text', text }]);
        showAlert('ส่งคำสั่งไปยังบอทแล้ว');
      } catch (e) { console.error(e); showAlert('ส่งข้อความไม่สำเร็จ'); }
    }

    function openPortal() { window.open(HOSPITAL_PORTAL_URL, '_blank'); }
    function openMap()    { window.open(`${API_BASE}/hospital/map`, '_blank'); }

    async function doShare() {
      try {
        if (USE_LIFF && typeof liff !== 'undefined' && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([{ type:'text', text:'ดูรายงาน: ' + window.location.href }]);
        } else {
          navigator.clipboard?.writeText(window.location.href);
          showAlert('คัดลอกลิงก์แล้ว');
        }
      } catch (e) { console.error(e); showAlert('แชร์ไม่สำเร็จ'); }
    }

    async function scanCode() {
      try {
        if (!(USE_LIFF && typeof liff !== 'undefined' && liff.isInClient() && liff.isApiAvailable('scanCodeV2'))) {
          showAlert('สแกนได้เมื่อเปิดใน LINE และเปิดใช้ LIFF');
          return;
        }
        const res = await liff.scanCodeV2();
        if (res?.value) showAlert('สแกนแล้ว: ' + res.value);
      } catch (e) { console.error(e); showAlert('สแกนไม่สำเร็จ'); }
    }

    async function boot() {
      // โหมดสาธิต (ไม่ใช้ LIFF) — ทำงานบน GitHub Pages ทันที
      await Promise.all([loadKPIs(), loadTopDiseases()]);
      document.getElementById('btnShare').addEventListener('click', doShare);
      document.getElementById('btnScan').addEventListener('click', scanCode);
      document.getElementById('btnRefresh').addEventListener('click', () => { loadKPIs(); loadTopDiseases(); });

      // ถ้าจะใช้ LIFF: เปิด USE_LIFF=true และเปิดสคริปต์ LIFF ด้านบน จากนั้น:
      // await liff.init({ liffId: LIFF_ID });
      // if (!liff.isLoggedIn()) liff.login();
      // const profile = await liff.getProfile();
      // document.getElementById('userName').textContent = `คุณ ${profile.displayName}`;
      // const pic = document.getElementById('userPicture'); pic.src = profile.pictureUrl; pic.classList.remove('hidden');
    }

    boot();
  </script>
</body>
</html>
